% mainfile: ../../Refinement.tex
\begin{figure}[h!]
  \centering
  \begin{tikzpicture}
	%\begin{scope}[node distance=15mm and 10mm]
	  \node[initial,state] (A)                          				{$\procdef{B_2}{i,o}$};
	  \node[state] 	       (B) [below of=A]             				{$\procchoice{\proccall{C_1}{i,o}}{\proccall{C_2}{i,o}}$};
	  \node[state]         (C) [below of=B, left of=B, xshift=-10, yshift=-5mm]  	{$\inp{i}{x}.\inp{i}{y}.\out{o}{x}.\out{o}{y}.\proccall{B_2}{i,o}$};
	  
 	  \node[state]	       (D')[below of=B, right of=B, xshift=10, yshift=4mm] 	{$\inp{i}{x}.\out{o}{x}.\inp{i}{y}.\out{o}{y}.\proccall{B_2}{i,o}$};
	  \node[state]         (L1)[below of=D', yshift=8mm, xshift=-6mm] 				{$\cdots$};	
	  \node[state]         (L')[below of=D', left of=D', xshift=7mm, yshift=2mm]     {$\out{o}{a}.\inp{i}{y}.\out{o}{y}.\proccall{B_2}{i,o}$};
%	  \node[state]         (X')[below of=L', yshift=14mm] 				{$\vdots$};
	  \node[state]         (R')[below of=D', yshift=-9mm]				         {$\out{o}{z}.\inp{i}{y}.\out{o}{y}.\proccall{B_2}{i,o}$};

	  \node[state]         (D) [below of=R'] 					{$\inp{i}{y}.\out{o}{y}.\proccall{B_2}{i,o}$};%, right of=B, xshift=10, yshift=5mm
	% right strand
	  \node[state] 	       (X1)[below of=D, sdots]		   			{$\cdots$};
	  \node[state]         (D1)[below of=D, xshift=-40]				{$\out{o}{a}.\proccall{B_2}{i,o}$};
	  \node[state]         (D2)[below of=D, xshift=40] 				{$\out{o}{z}.\proccall{B_2}{i,o}$};
	% left strand
	  \node[state] 	       (X2)[below of=C, sdots]					{$\cdots$};
	  \node[state]         (C1)[below of=C, xshift=-65] 				{$\inp{i}{y}.\out{o}{a}.\out{o}{y}.\proccall{B_2}{i,o}$};
	  \node[state]         (C2)[below of=C, xshift=65] 				{$\inp{i}{y}.\out{o}{z}.\out{o}{y}.\proccall{B_2}{i,o}$};
	  \node[state]         (L1)[below of=C2, yshift=1cm] 				{$\vdots$};
	  \node[state] 	       (X3)[below of=C1, sdots]		    			{$\cdots$};
	  \node[state]         (C3)[below of=C1, xshift=-50] 				{$\out{o}{a}.\out{o}{a}.\proccall{B_2}{i,o}$};
	  \node[state]         (C4)[below of=C1, xshift=50] 				{$\out{o}{a}.\out{o}{z}.\proccall{B_2}{i,o}$};
	  \node[state]         (C5)[below of=C3]					{$\out{o}{a}.\proccall{B_2}{i,o}$};
	  \node[state]         (C6)[below of=C4]					{$\out{o}{z}.\proccall{B_2}{i,o}$};
	%\end{scope}
	  \path (A)		edge						node[right]		{$\tau$}	(B)
		(B)		edge						node[ldiag]		{$\tau$}     	(C)
		    		edge						node[rdiag,pos=0.1]	{$\tau$}     	(D')	
		(C) 		edge						node[ldiag]		{$\inpa{i}{a}$}	(C1)
		    		edge						node[rdiag]		{$\inpa{i}{z}$}	(C2)
		(C1) 		edge						node[ldiag]		{$\inpa{i}{a}$}	(C3)
		    		edge						node[rdiag]		{$\inpa{i}{z}$}	(C4)
		(C3)		edge						node[left]		{$\outa{o}{a}$}	(C5)
		(C4)		edge						node[right]		{$\outa{o}{a}$}	(C6)
		(D) 		edge						node[ldiag]		{$\inpa{i}{a}$}	(D1)
		    		edge						node[rdiag]		{$\inpa{i}{z}$}	(D2)
		(R')     	edge						node[right]		{$\outa{o}{z}$} (D)
		(D')		edge						node[ldiag]		{$\inpa{i}{a}$} (L')
				edge						node[right]		{$\inpa{i}{z}$} (R')
		(L')		edge[bend right=30]				node[left,pos=0.7]	{$\outa{o}{a}$} (D)
		(D2.east) 	edge[bend right=30, dopac]			node[right]		{$\outa{o}{z}$}	(A.east)
		(D1) 		edge[bend left=60, dopac]			node[left,pos=0.8]	{$\outa{o}{a}$}	(A.south west)
		(C6.east)	edge[bend right=40, dopac]	node[right,pos=0.3]		{$\outa{o}{z}$}	(A.south east)
		(C5.west) 	edge[bend left=40, dopac, looseness=1]		node[left]		{$\outa{o}{a}$}	(A.west);
  \end{tikzpicture}
\caption{The operational semantics for buffer $B_2$ from \refEx{ex_two_cell_buffer_mine}.}
\label{fig_ts_buffer_fifo_1}
\end{figure}
